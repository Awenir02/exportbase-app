<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ (Export-Base)</title>
    <script src="//api.bitrix24.com/api/v1/"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 16px;
        background: #f5f7fa;
      }
      h2 {
        margin-bottom: 12px;
      }
      input,
      button {
        padding: 8px;
        margin: 5px 0;
        width: 100%;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        background: #2fc6f6;
        color: #fff;
        cursor: pointer;
        border: none;
        transition: background 0.2s;
      }
      button:hover {
        background: #1baddc;
      }
      pre {
        background: #fff;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 6px;
        overflow: auto;
        max-height: 300px;
      }
    </style>
  </head>
  <body>
    <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ Export-Base</h2>
    <input type="text" id="inn" placeholder="–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù" />
    <button id="check">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    <pre id="result">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>

    <script>
      const PROXY_URL =
        "https://script.google.com/macros/s/AKfycbyuI2twj2dbsY6fr7_qBwc2-33mLn25sMk9jX9c545KGfeOR4ipm6XZh_pjkTyhS1xDNw/exec";
      const API_KEY = "epswrrlehbimgd9";

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ò–ù–ù –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ CRM
      BX24.ready(() => {
        BX24.init(() => {
          BX24.callMethod(
            "crm.company.get",
            { id: BX24.placement.info().options.ID },
            (res) => {
              if (res && res.data() && res.data().UF_CRM_INN) {
                document.getElementById("inn").value = res.data().UF_CRM_INN;
              }
            }
          );
        });
      });

      document.getElementById("check").addEventListener("click", async () => {
        const inn = document.getElementById("inn").value.trim();
        const resultBox = document.getElementById("result");

        if (!inn) {
          resultBox.textContent = "–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù!";
          return;
        }

        const apiUrl = `https://export-base.ru/api/company/?inn=${inn}&key=${API_KEY}`;
        const fullUrl = `${PROXY_URL}?url=${encodeURIComponent(apiUrl)}`;

        resultBox.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";

        try {
          const res = await fetch(fullUrl);
          const data = await res.json();

          if (data.error) {
            resultBox.textContent = "–û—à–∏–±–∫–∞: " + data.error;
          } else if (data.companies_data && data.companies_data.length > 0) {
            const company = data.companies_data[0];
            resultBox.textContent =
              `üè¢ ${company.legal_name}\n` +
              `üìç ${company.address}\n` +
              `üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${company.reg_date}\n` +
              `üë®‚Äçüíº ${company.ceo_name} (${company.ceo_position})\n` +
              `üíº –û–ö–í–≠–î: ${company.main_okved_name}\n` +
              `üìû ${company.stationary_phone || "-"}\n` +
              `üìß ${company.email || "-"}`;
          } else {
            resultBox.textContent = "–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.";
          }
        } catch (err) {
          resultBox.textContent = "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err.message;
        }
      });
    </script>
  </body>
</html>
